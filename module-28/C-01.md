## 1️⃣ comment create করার পুরো process step-by-step (Schema → Service → Controller → API)

`prisma/schema.prisma`:

```prisma
model Comment {
  id        String    @id @default(uuid())
  content   String
  post      Post      @relation(fields: [postId], references: [id])
  postId    String
  author    User      @relation(fields: [authorId], references: [id])
  authorId  String
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  parentId  String?
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime  @default(now())
}
```

**Explanation:**

- `parentId` → যদি null থাকে, মূল comment
- `replies` → child comments / replies
- `@relation("CommentReplies")` → self-relation

**Migration:**

```bash
npx prisma migrate dev --name add_parent_comment
```

---

## 2️⃣ Service Layer

`comment.service.ts`:

```typescript
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export const createComment = async ({
  content,
  postId,
  authorId,
  parentId,
}: {
  content: string;
  postId: string;
  authorId: string;
  parentId?: string;
}) => {
  try {
    // ১. ভ্যালিডেশন চেক: কন্টেন্ট খালি কি না
    if (!content || content.trim() === "") {
      throw new Error("কমেন্টের লিখা খালি হতে পারবে না। | Content is required");
    }

    // ২. ডাটাবেসে কমেন্ট তৈরি করা
    const comment = await prisma.comment.create({
      data: {
        content,
        postId,
        authorId,
        // parentId যদি থাকে তবে সেটি বসবে, না থাকলে null হবে (অর্থাৎ এটি মেইন কমেন্ট)
        parentId: parentId || null,
      },
      include: {
        // কমেন্টের সাথে ইউজারের প্রোফাইল তথ্যও নিয়ে আসবে
        author: {
          select: {
            id: true,
            name: true,
            image: true,
          },
        },
        // রিপ্লাইগুলোর ক্ষেত্রে নেস্টেড তথ্য পাওয়ার জন্য
        replies: {
          include: {
            author: true,
          },
        },
      },
    });

    return comment;
  } catch (error) {
    if (error.code === "P2003") {
      throw new Error("Invalid Post or Author ID | ভুল পোস্ট অথবা ইউজার আইডি");
    }

    console.error("Comment Creation Error:", error);
    throw new Error(
      error.message || "Failed to create comment | কমেন্ট তৈরি করা সম্ভব হয়নি"
    );
  }
};
```

নিচে প্রতিটি অংশের বিস্তারিত ব্যাখ্যা দেওয়া হলো:

---

### ১. ফাংশনাল স্ট্রাকচার (Parameters)

```typescript
export const createComment = async ({ content, postId, authorId, parentId }: { ... }) => {

```

- **content**: কমেন্টের মূল লিখা।
- **postId**: এই কমেন্টটি কোন পোস্টের আন্ডারে করা হচ্ছে তার আইডি।
- **authorId**: যে ইউজার কমেন্টটি করছে তার আইডি।
- **parentId (Optional)**: যদি কেউ অন্য কোনো কমেন্টের রিপ্লাই দেয়, তবে সেই মেইন কমেন্টের আইডি এখানে আসবে। মেইন কমেন্ট হলে এটি ফাঁকা থাকবে।

---

### ২. ইনপুট ভ্যালিডেশন (Validation)

```typescript
if (!content || content.trim() === "") {
  throw new Error("কমেন্টের লিখা খালি হতে পারবে না। | Content is required");
}
```

এখানে চেক করা হচ্ছে যেন কেউ ফাঁকা কমেন্ট বা শুধু স্পেস দিয়ে কমেন্ট সেভ করতে না পারে। যদি কন্টেন্ট না থাকে, তবে কোডটি আর সামনে বাড়বে না এবং একটি এরর থ্রো করবে।

---

### ৩. ডাটাবেস অপারেশন ও ডাটা রিলেশন (Prisma Create & Include)

এই অংশটি সবচেয়ে গুরুত্বপূর্ণ। এখানে আমরা ডাটাবেসকে বলছি একটি নতুন ডাটা তৈরি করতে এবং সাথে কিছু বাড়তি তথ্য দিতে।

- **data**: এখানে আমরা ডাটাবেসের কলাম অনুযায়ী ভ্যালুগুলো পাঠাচ্ছি। `parentId: parentId || null` এর মানে হলো যদি এটি রিপ্লাই না হয়, তবে ডাটাবেসে এটি `null` হিসেবে জমা হবে।
- **include**: এটি SQL-এর **JOIN** এর মতো কাজ করে।
- **author**: কমেন্ট যে করেছে, তার পুরো অবজেক্ট না নিয়ে আমরা শুধু `id`, `name`, এবং `image` সিলেক্ট করেছি। এতে সিকিউরিটি বজায় থাকে (যেমন পাসওয়ার্ড লিক হয় না)।
- **replies**: এটি একটি চমৎকার ফিচার। এই কমেন্টের আন্ডারে যদি অন্য কোনো রিপ্লাই থাকে, তবে সেগুলোও একটি অ্যারে হিসেবে চলে আসবে। এমনকি রিপ্লাইগুলো কে করেছে (`author: true`), তাও আমরা সাথে নিয়ে আসছি।

---

### ৪. এরর হ্যান্ডেলিং (Error Handling)

```typescript
catch (error) {
  if (error.code === "P2003") {
    throw new Error("Invalid Post or Author ID | ভুল পোস্ট অথবা ইউজার আইডি");
  }
}

```

- **P2003**: এটি একটি Prisma এরর কোড। এর মানে হলো **Foreign Key Constraint Fail**। সহজ বাংলায়—আপনি এমন কোনো `postId` বা `authorId` পাঠিয়েছেন যা ডাটাবেসেই নেই।
- **General Catch**: অন্য যেকোনো টেকনিক্যাল এরর হলে তা কনসোলে প্রিন্ট হবে এবং ইউজারকে একটি মেসেজ দিবে।

---

### এই ফাংশনটি শেষে যা রিটার্ন করবে (Example Output)

ফাংশনটি সফলভাবে চললে আপনি নিচের মতো একটি অবজেক্ট পাবেন:

```json
{
  "id": "comment_123",
  "content": "Nice post!",
  "postId": "post_456",
  "authorId": "user_789",
  "parentId": null,
  "author": {
    "id": "user_789",
    "name": "Arif",
    "image": "profile.jpg"
  },
  "replies": [] // যদি কোনো রিপ্লাই না থাকে
}
```

## 3️⃣ Controller

`comment.controller.ts`:

```ts
export const createCommentController = async (req: Request, res: Response) => {
  try {
    const { content, postId, parentId } = req.body;
    const authorId = req.user?.id; // এটা আসবে middlewhre থেকে

    if (!authorId) return res.status(401).json({ message: "Unauthorized" });
    if (!content || !postId)
      return res.status(400).json({ message: "Missing content or postId" });

    const comment = await commentService.createComment({
      content,
      postId,
      authorId,
      parentId, // optional
    });

    res.status(201).json({ success: true, comment });
  } catch (error) {
    console.error(error);
    res.status(500).json({ success: false, message: "Server error" });
  }
};
```

নিচে এর প্রতিটি লাইনের বিস্তারিত ব্যাখ্যা দেওয়া হলো:

---

### ১. ডেটা রিসিভ করা (Extracting Data)

```ts
const { content, postId, parentId } = req.body;
const authorId = req.user?.id;
```

- **req.body**: ফ্রন্টএন্ড থেকে ইউজার যে ডেটাগুলো পাঠিয়েছে (কমেন্টের লিখা, কোন পোস্টের আইডি ইত্যাদি), তা এখান থেকে পাওয়া যাচ্ছে।
- **req.user?.id**: এটি খুবই গুরুত্বপূর্ণ। সাধারণত একটি `Auth Middleware` চেক করে যে ইউজার লগইন করা আছে কি না। যদি লগইন করা থাকে, তবে সেই ইউজারের আইডি `req.user`-এ সেট করে দেওয়া হয়। এখান থেকেই আমরা `authorId` পাচ্ছি।

### ২. সিকিউরিটি এবং ভ্যালিডেশন চেক (Guards)

```ts
if (!authorId) return res.status(401).json({ message: "Unauthorized" });
if (!content || !postId)
  return res.status(400).json({ message: "Missing content or postId" });
```

- **Unauthorized (401)**: যদি `authorId` না থাকে, তার মানে ইউজার লগইন করা নেই। লগইন ছাড়া কমেন্ট করতে দেওয়া হবে না।
- **Bad Request (400)**: যদি ইউজার কমেন্টের টেক্সট বা পোস্টের আইডি না পাঠায়, তবে তাকে এরর মেসেজ দিয়ে থামিয়ে দেওয়া হবে। এতে আপনার সার্ভারের সার্ভিস ফাংশনটি অকারণে রান হবে না।

### ৩. সার্ভিস ফাংশন কল করা (The Logic Layer)

```ts
const comment = await commentService.createComment({
  content,
  postId,
  authorId,
  parentId,
});
```

কন্ট্রোলার নিজে ডাটাবেসে ডেটা সেভ করে না। সে সব ডেটা গুছিয়ে `createComment` সার্ভিস ফাংশনটির কাছে পাঠিয়ে দেয়। সার্ভিস ফাংশন ডাটাবেসে কাজ শেষ করে নতুন তৈরি হওয়া কমেন্টটি রিটার্ন করে।

---

## 4️⃣ Request Example (Reply to Comment)

**POST `/api/comments`**

```json
{
  "content": "This is a reply",
  "postId": "uuid-of-post",
  "parentId": "uuid-of-parent-comment"
}
```

**Top-level comment এর parentId = null**
**Reply এর parentId = parent comment id**

---

## 5️⃣ Response Example

```json
{
  "id": "uuid",
  "content": "This is a reply",
  "postId": "uuid-of-post",
  "authorId": "uuid-of-user",
  "parentId": "uuid-of-parent-comment",
  "createdAt": "2026-01-04T00:00:00.000Z",
  "author": { "id": "...", "email": "...", "name": "..." },
  "replies": []
}
```
