## 1️⃣ comment create করার পুরো process step-by-step

`prisma/schema.prisma`:

```prisma
model Comment {
  id        String    @id @default(uuid())
  content   String
  post      Post      @relation(fields: [postId], references: [id])
  postId    String
  author    User      @relation(fields: [authorId], references: [id])
  authorId  String
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  parentId  String?
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime  @default(now())
}
```

**Explanation:**

- `parentId` → যদি null থাকে, মূল comment
- `replies` → child comments / replies
- `@relation("CommentReplies")` → self-relation

**Migration:**

```bash
npx prisma migrate dev --name add_parent_comment
```

---

## 2️⃣ Service Layer

`comment.service.ts`:

```ts
export const createComment = async ({
  content,
  postId,
  authorId,
  parentId,
}: {
  content: string;
  postId: string;
  authorId: string;
  parentId?: string;
}) => {
  const comment = await prisma.comment.create({
    data: {
      content,
      postId,
      authorId,
      parentId: parentId || null,
    },
    include: {
      author: true,
      replies: true, // nested replies
    },
  });

  return comment;
};

export const getCommentsByPost = async (postId: string) => {
  return prisma.comment.findMany({
    where: { postId, parentId: null }, // only top-level comments
    include: {
      author: true,
      replies: {
        include: { author: true },
      },
    },
    orderBy: { createdAt: "desc" },
  });
};
```

---

## 3️⃣ Controller

`comment.controller.ts`:

```ts
export const createCommentController = async (req: Request, res: Response) => {
  try {
    const { content, postId, parentId } = req.body;
    const authorId = req.user?.id;

    if (!authorId) return res.status(401).json({ message: "Unauthorized" });
    if (!content || !postId)
      return res.status(400).json({ message: "Missing content or postId" });

    const comment = await commentService.createComment({
      content,
      postId,
      authorId,
      parentId, // optional
    });

    res.status(201).json({ success: true, comment });
  } catch (error) {
    console.error(error);
    res.status(500).json({ success: false, message: "Server error" });
  }
};
```

---

## 4️⃣ Request Example (Reply to Comment)

**POST `/api/comments`**

```json
{
  "content": "This is a reply",
  "postId": "uuid-of-post",
  "parentId": "uuid-of-parent-comment"
}
```

**Top-level comment এর parentId = null**
**Reply এর parentId = parent comment id**

---

## 5️⃣ Response Example

```json
{
  "id": "uuid",
  "content": "This is a reply",
  "postId": "uuid-of-post",
  "authorId": "uuid-of-user",
  "parentId": "uuid-of-parent-comment",
  "createdAt": "2026-01-04T00:00:00.000Z",
  "author": { "id": "...", "email": "...", "name": "..." },
  "replies": []
}
```
