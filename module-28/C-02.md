## 1️⃣ Service Layer – `post.service.ts`

`getPostById` _সার্ভিস ফাংশনটি মূলত ডাটাবেস থেকে একটি নির্দিষ্ট পোস্টের সমস্ত তথ্য খুঁজে বের করার জন্য ডিজাইন করা হয়েছে। এর বিশেষত্ব হলো এটি একই সাথে পোস্টের লেখক, কমেন্ট এবং কমেন্টের নিচে থাকা রিপ্লাইগুলোকে একটি নেস্টেড (স্তরভিত্তিক) আকারে নিয়ে আসে।_

```ts
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export const getPostById = async (id: string) => {
  try {
    if (!id || id.trim() === "") {
      throw new Error("পোস্ট আইডি দিতে হবে | Post ID is required");
    }

    const post = await prisma.post.findUnique({
      where: { id },
      include: {
        author: {
          select: { id: true, name: true, image: true },
        },
        comments: {
          where: { parentId: null }, // শুধু টপ-লেভেল কমেন্ট
          include: {
            author: {
              select: { id: true, name: true, image: true },
            },
            replies: {
              include: {
                author: {
                  select: { id: true, name: true, image: true },
                },
              },
            },
          },
          orderBy: { createdAt: "desc" },
        },
        _count: {
          select: { comments: true }, // মোট কমেন্ট সংখ্যা
        },
      },
    });

    if (!post) {
      throw new Error("পোস্ট পাওয়া যায়নি | Post not found");
    }

    return post;
  } catch (error) {
    console.error("Get Post Error:", error);
    throw new Error(error.message || "Failed to get post");
  }
};
```

নিচে কোডটির প্রতিটি অংশের বিস্তারিত ব্যাখ্যা দেওয়া হলো:

### ১. ইনপুট ভ্যালিডেশন (Input Check)

```ts
if (!id || id.trim() === "") {
  throw new Error("পোস্ট আইডি দিতে হবে | Post ID is required");
}
```

শুরুতেই চেক করা হচ্ছে যে `id` পাঠানো হয়েছে কি না। আইডি না থাকলে ডাটাবেস কুয়েরি করার প্রয়োজন নেই, তাই এখানেই এরর থ্রো করা হচ্ছে।

### ২. মেইন কুয়েরি (`prisma.post.findUnique`)

```ts
const post = await prisma.post.findUnique({
  where: { id },
  include: { ... }
});

```

- `findUnique` ব্যবহার করা হয় কারণ প্রতিটি পোস্টের আইডি আলাদা (Unique) থাকে। এটি নির্দিষ্ট একটি রো (Row) খুঁজে বের করে।
- `include`: এটি SQL-এর **Join** এর মতো কাজ করে। এর মাধ্যমে আমরা পোস্টের সাথে রিলেটেড অন্যান্য টেবিলের ডেটাও একবারে পাচ্ছি।

### ৩. অথর বা লেখকের তথ্য (Include Author)

```ts
author: {
  select: { id: true, name: true, image: true },
},

```

পোস্টটি কে লিখেছে তার তথ্য এখানে আসছে। `select` ব্যবহার করার সুবিধা হলো ডাটাবেস থেকে ইউজারের সব তথ্য (যেমন: পাসওয়ার্ড বা ইমেইল) না নিয়ে শুধু প্রয়োজনীয় `id`, `name`, এবং `image` নেওয়া হচ্ছে। এটি সিকিউরিটির জন্য ভালো।

### ৪. কমেন্ট লজিক (Include Comments & Filter)

```ts
comments: {
  where: { parentId: null }, // শুধু টপ-লেভেল কমেন্ট
  orderBy: { createdAt: "desc" },
  include: { ... }
}

```

এখানে একটি চমৎকার লজিক আছে:

- **`where: { parentId: null }`**: এটি শুধুমাত্র সেই কমেন্টগুলো আনবে যেগুলো সরাসরি পোস্টের নিচে করা হয়েছে (Main Comments)। এটি রিপ্লাইগুলোকে বাদ দিয়ে দেবে যাতে ডেটা তালগোল পাকিয়ে না যায়।
- **`orderBy`**: নতুন কমেন্টগুলো সবার উপরে দেখানোর জন্য `desc` (descending) অর্ডার ব্যবহার করা হয়েছে।

### ৫. রিপ্লাই লজিক (Nested Replies)

```ts
replies: {
  include: {
    author: {
      select: { id: true, name: true, image: true },
    },
  },
},

```

প্রতিটি মেইন কমেন্টের ভেতরে থাকা রিপ্লাইগুলোকে এখানে `include` করা হয়েছে। এবং রিপ্লাইটি কে লিখেছে তার তথ্যও (`author`) সাথে নিয়ে আসা হচ্ছে।

### ৬. পোস্ট না পাওয়া গেলে এরর (Post Not Found)

```ts
if (!post) {
  throw new Error("পোস্ট পাওয়া যায়নি | Post not found");
}
```

আইডি সঠিক হলেও যদি ডাটাবেসে ওই আইডির কোনো পোস্ট না থাকে, তবে একটি কাস্টম মেসেজ দেওয়া হচ্ছে।

---

### ডেটার গঠন (Data Hierarchy):

এই ফাংশনটি কল করলে আপনি যে ডেটা পাবেন তার সিরিয়াল হবে অনেকটা এরকম:

1. **Post** (পোস্টের মূল তথ্য)
2. ↳ **Author** (পোস্টের লেখক)
3. ↳ **Comments** (পোস্টের মেইন কমেন্টগুলো)

- ↳ **Author** (কমেন্টের লেখক)
- ↳ **Replies** (কমেন্টের রিপ্লাইগুলো)
- ↳ **Author** (রিপ্লাইয়ের লেখক)

---

## 2️⃣ Controller – `post.controller.ts`

```ts
import { Request, Response } from "express";
import * as postService from "./post.service";

export const getPostController = async (req: Request, res: Response) => {
  try {
    const { id } = req.params; // এখানে id মানে post id

    if (!id) {
      return res
        .status(400)
        .json({ success: false, message: "Missing post ID" });
    }

    const post = await postService.getPostById(id);
    res.status(200).json({ success: true, post });
  } catch (error) {
    console.error(error);
    res.status(404).json({ success: false, message: error.message });
  }
};
```

---

## 3 Example Response

**GET `/api/posts/:id`**

```json
{
  "success": true,
  "post": {
    "id": "post_123",
    "title": "My First Post",
    "author": { "id": "user_1", "name": "Arif", "image": "arif.jpg" },
    "comments": [
      {
        "id": "comment_1",
        "content": "Nice post!",
        "author": { "id": "user_2", "name": "Rahim" },
        "replies": [
          {
            "id": "comment_2",
            "content": "Thanks!",
            "author": { "id": "user_1", "name": "Arif" }
          }
        ]
      }
    ],
    "_count": {
      "comments": 2
    }
  }
}
```
