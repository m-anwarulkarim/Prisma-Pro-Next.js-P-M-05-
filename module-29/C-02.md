ржПржЦржи **`handlePrismaError.ts` ржарж┐ржХ ржХрзЛржерж╛рзЯ, ржХрзАржнрж╛ржмрзЗ, ржХрзЛржи flow-рждрзЗ ржмрзНржпржмрж╣рж╛рж░ рж╣ржмрзЗ** тАФ **ржмрж╛рж╕рзНрждржм code ржжрж┐рзЯрзЗ end-to-end**

# ЁЯзй `handlePrismaError` тАФ ржмрзНржпржмрж╣рж╛рж░ (REAL PROJECT FLOW)

ржЖржорж░рж╛ рзкржЯрж╛ ржЬрж╛рзЯржЧрж╛ ржжрзЗржЦржм ЁЯСЗ
1я╕ПтГг `catchAsync`
2я╕ПтГг Controller
3я╕ПтГг Service
4я╕ПтГг **Global Error Handler (ржПржЦрж╛ржирзЗржЗ handlePrismaError use рж╣рзЯ)** тнР

---

## 1я╕ПтГг catchAsync.ts тАФ Error ржХрзЗ next ржП ржкрж╛ржарж╛ржирзЛрж░ ржорзЗрж╢рж┐ржи

ЁЯУН `src/utils/catchAsync.ts`

```ts
import { Request, Response, NextFunction } from "express";

export const catchAsync =
  (fn: Function) => (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
```

ЁЯФС **ржПржЯрж╛ржЗ bridge**

- async error тЖТ `next(err)` тЖТ global error handler

---

## 2я╕ПтГг Service Layer тАФ Prisma query (NO handling)

ЁЯУН `src/modules/post/post.service.ts`

```ts
import prisma from "../../prisma";

const createPost = async (payload: any) => {
  // тЭМ try-catch ржжрж░ржХрж╛рж░ ржирзЗржЗ
  return prisma.post.create({
    data: payload,
  });
};

export const PostService = {
  createPost,
};
```

ЁЯСЙ ржПржЦрж╛ржирзЗ ржпржжрж┐:

- duplicate title
- invalid authorId
  тЖТ Prisma ржирж┐ржЬрзЗржЗ error throw ржХрж░ржмрзЗ

---

## 3я╕ПтГг Controller тАФ clean + catchAsync

ЁЯУН `src/modules/post/post.controller.ts`

```ts
import { catchAsync } from "../../utils/catchAsync";
import { PostService } from "./post.service";

export const createPost = catchAsync(async (req, res) => {
  const result = await PostService.createPost(req.body);

  res.status(201).json({
    success: true,
    data: result,
  });
});
```

тЭМ ржПржЦрж╛ржирзЗ:

- Prisma error ржирж╛ржЗ
- try-catch ржирж╛ржЗ
- next ржирж╛ржЗ

тЬФ error рж╣рж▓рзЗ `catchAsync` ржирж┐ржЬрзЗ `next(err)` ржХрж░ржмрзЗ

---

## 4я╕ПтГг тнР Global Error Handler тАФ ржПржЦрж╛ржирзЗржЗ handlePrismaError ржмрзНржпржмрж╣рж╛рж░

ЁЯУН `src/middlewares/globalErrorHandler.ts`

```ts
import { Request, Response, NextFunction } from "express";
import { handlePrismaError } from "../errors/handlePrismaError";

export const globalErrorHandler = (
  err: any,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  let statusCode = err.statusCode || 500;
  let message = err.message || "Something went wrong";

  // тЬЕ Prisma Client Known Request Error
  if (err.name === "PrismaClientKnownRequestError") {
    const simplifiedError = handlePrismaError(err);
    statusCode = simplifiedError.statusCode;
    message = simplifiedError.message;
  }

  res.status(statusCode).json({
    success: false,
    message,
  });
};
```

ЁЯФС **ржПржЗржЦрж╛ржирзЗржЗ** `handlePrismaError()` call рж╣ржЪрзНржЫрзЗ
ЁЯСЙ ржЕржирзНржп ржХрзЛржерж╛ржУ ржирж╛

---

## 5я╕ПтГг App.ts / server.ts тАФ middleware order (VERY IMPORTANT)

```ts
app.use("/api/posts", postRoutes);

// тЭЧ рж╕ржм route ржПрж░ ржкрж░рзЗ
app.use(globalErrorHandler);
```

---

# ЁЯФБ Full Runtime Flow (Line by Line)

ржзрж░рж╛ ржпрж╛ржХ duplicate email ржжрж┐рзЯрзЗ post create ржХрж░ржЫрзЛ ЁЯСЗ

```text
Client request
 тЖУ
Route
 тЖУ
Controller (catchAsync)
 тЖУ
Service (prisma.post.create)
 тЖУ
Prisma throws P2002
 тЖУ
catchAsync тЖТ next(err)
 тЖУ
Global Error Handler
 тЖУ
handlePrismaError(err)
 тЖУ
Client gets clean message
```

---

## ЁЯУд Client Response (Example)

### Duplicate value (P2002)

```json
{
  "success": false,
  "message": "Duplicate value for title"
}
```

### Record not found (P2025)

```json
{
  "success": false,
  "message": "Record not found"
}
```

---

# тЭУ FAQ (рждрзЛржорж╛рж░ ржЖржЧрзЗрж░ confusion)

### тЭУ Controller ржП next рж▓рж╛ржЧржмрзЗ?

тЭМ ржирж╛
ЁЯСЙ `catchAsync` ржирж┐ржЬрзЗржЗ next call ржХрж░рзЗ

---

### тЭУ Global error handler ржП next call ржХрж░ржм?

тЭМ ржирж╛
ЁЯСЙ response ржкрж╛ржарж╛ржирзЛржЗ error lifecycle ржПрж░ рж╢рзЗрж╖

---

### тЭУ catchAsync ржХрж┐ built-in?

тЭМ ржирж╛
ЁЯСЙ ржПржЯрж╛ **custom utility**

---

### тЭУ Service ржП try-catch ржжрж░ржХрж╛рж░?

тЭМ ржирж╛ (default case)
тЬФ рж╢рзБржзрзБ business error convert ржХрж░рж▓рзЗ

---

# ЁЯз╛ ржПржХ рж▓рж╛ржЗржирзЗ ржорзБржЦрж╕рзНрже

> **Prisma error ржЙржаржмрзЗ Service ржП, ржзрж░рж╛ рж╣ржмрзЗ Global Error Handler ржП,
> Controller ржХрж┐ржЫрзБржЗ ржЬрж╛ржиржмрзЗ ржирж╛ред**
