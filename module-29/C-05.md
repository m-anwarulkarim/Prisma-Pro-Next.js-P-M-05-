# ‡¶è‡¶ñ‡¶® ‡¶¶‡ßá‡¶ñ‡¶¨‡ßã PrismaClientValidationError ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶π‡ßü, ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá, ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá client response ‡¶¶‡ßá‡ßü‡•§

---

## 1Ô∏è‚É£ catchAsync ‚Äî Utility Function

üìç `src/utils/catchAsync.ts`

```ts
import { Request, Response, NextFunction } from "express";

// async function ‡¶ï‡ßá wrap ‡¶ï‡¶∞‡ßá, error automatically next() ‡¶™‡¶æ‡¶†‡¶æ‡¶Ø‡¶º
export const catchAsync =
  (fn: (req: Request, res: Response, next: NextFunction) => Promise<any>) =>
  (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
```

‚úÖ ‡¶ï‡¶æ‡¶ú:

- Controller ‡¶è async function ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá, ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã error automatically `next(err)` ‡¶¶‡¶ø‡ßü‡ßá Global Error Handler ‡¶è ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§

---

## 2Ô∏è‚É£ Service Layer ‚Äî Prisma Query

üìç `src/modules/post/post.service.ts`

```ts
import prisma from "../../prisma";

const createPost = async (payload: any) => {
  // ‚ùå try-catch ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
  // ‚ùå PrismaClientValidationError ‡¶è‡¶ñ‡¶æ‡¶®‡ßá handle ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶®‡¶æ
  return prisma.post.create({
    data: payload,
  });
};

export const PostService = {
  createPost,
};
```

- Service ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ query ‡¶≤‡¶ø‡¶ñ‡¶¨‡ßá‡•§
- ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã **ValidationError** ‡¶¨‡¶æ **KnownRequestError** ‡¶π‡ßü ‚Üí throw ‡¶π‡¶¨‡ßá‡•§

---

## 3Ô∏è‚É£ Controller ‚Äî catchAsync ‡¶¶‡¶ø‡ßü‡ßá wrap ‡¶ï‡¶∞‡¶æ

üìç `src/modules/post/post.controller.ts`

```ts
import { catchAsync } from "../../utils/catchAsync";
import { PostService } from "./post.service";

export const createPost = catchAsync(async (req, res) => {
  const result = await PostService.createPost(req.body);

  res.status(201).json({
    success: true,
    data: result,
  });
});
```

- Controller clean ‡¶•‡¶æ‡¶ï‡ßá, ‡¶ï‡ßã‡¶®‡ßã Prisma-specific code ‡¶®‡ßá‡¶á‡•§
- Async function ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶≤‡ßá **catchAsync** automatically `next(err)` ‡¶ï‡¶∞‡¶¨‡ßá‡•§

---

## 4Ô∏è‚É£ Global Error Handler ‚Äî PrismaClientValidationError handle ‡¶ï‡¶∞‡¶æ

üìç `src/middlewares/globalErrorHandler.ts`

```ts
import { handlePrismaError } from "../errors/handlePrismaError";
export const globalErrorHandler = (err, req, res, next) => {
  let statusCode = 500;
  let message = "Something went wrong";

  // Prisma Known Request Error ‚Üí mapping function ‡¶¶‡¶ø‡ßü‡ßá human-readable message
  if (err.name === "PrismaClientKnownRequestError") {
    const simplified = handlePrismaError(err);
    statusCode = simplified.statusCode;
    message = simplified.message;
  }

  // Prisma Validation Error ‚Üí generic 400 response
  else if (err.name === "PrismaClientValidationError") {
    statusCode = 400;
    message = "Invalid request data";
  }

  res.status(statusCode).json({
    success: false,
    message,
  });
};
```

‚úÖ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∑‡ßü :

- ValidationError ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø **handlePrismaError ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á**
- ‡¶∂‡ßÅ‡¶ß‡ßÅ generic 400 response‡•§

---

## 5Ô∏è‚É£ Full Runtime Flow (catchAsync + ValidationError)

```text
Client request ‚Üí Route ‚Üí Controller (catchAsync)
                     ‚Üì
                   Service ‚Üí Prisma query
                     ‚Üì
             Prisma throws ValidationError
                     ‚Üì
          catchAsync ‚Üí next(err)
                     ‚Üì
         Global Error Handler
                     ‚Üì
         Client receives 400 response
```

---

## 6Ô∏è‚É£ Real Example

### ‚ùå Field name typo

```ts
await prisma.post.create({
  data: {
    titile: "Hello World", // typo!
  },
});
```

- Prisma throws `PrismaClientValidationError`
- Client receives:

```json
{
  "success": false,
  "message": "Invalid request data"
}
```

### ‚ùå Missing required field

```ts
await prisma.post.create({
  data: {
    content: "This is post content", // missing title
  },
});
```

- Client receives same 400 response

---

## üîë Key Points (catchAsync + ValidationError)

1. Controller ‡¶è clean, async code ‡¶∂‡ßÅ‡¶ß‡ßÅ catchAsync ‡¶¶‡¶ø‡ßü‡ßá wrap ‡¶ï‡¶∞‡ßã‡•§
2. Service ‡¶è Prisma query ‡¶≤‡¶ø‡¶ñ‡¶¨‡ßá, try-catch optional‡•§
3. PrismaClientValidationError automatically Global Error Handler ‡¶è 400 response ‡¶¶‡ßá‡¶¨‡ßá‡•§
4. Client friendly, secure, ‡¶è‡¶¨‡¶Ç production-ready‡•§
