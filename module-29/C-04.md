# ЁЯФР Prisma: Role-Based Post Update Access

### ЁЯОп ржЙржжрзНржжрзЗрж╢рзНржп

ржПржЗ рж╕рж┐рж╕рзНржЯрзЗржорзЗрж░ ржорж╛ржзрзНржпржорзЗ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛ рж╣рзЯ ржпрзЗтАФ

- тЬЕ **Admin** тЖТ ржпрзЗржХрзЛржирзЛ Post Update ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
- тЬЕ **Author/User** тЖТ **рж╢рзБржзрзБ ржирж┐ржЬрзЗрж░ Post** Update ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
- тЭМ ржЕржирзНржп User тЖТ ржЕржирзНржпрзЗрж░ Post Update ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛

## ЁЯУМ Controller ржЙржжрж╛рж╣рж░ржг

```ts
export const updatePostController = async (req, res) => {
  const { postId } = req.params;
  const user = req.user; // Better Auth ржерзЗржХрзЗ

  const updatedPost = await updatePost(
    postId,
    user.id,
    user.role, // Prisma Enum
    req.body
  );

  res.status(200).json({
    success: true,
    data: updatedPost,
  });
};
```

ржПржЗ ржХрзЛржбржЯрж┐ ржПржХржЯрж┐ **Express.js Controller**, ржпрж╛ ржХрзЛржирзЛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржкрзЛрж╕рзНржЯ ржЖржкржбрзЗржЯ ржХрж░рж╛рж░ ржЬржирзНржп ржмрзНржпржмрж╣рзГржд рж╣рзЯред ржирж┐ржЪрзЗ ржПрж░ ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖рзЯржЧрзБрж▓рзЛрж░ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ:

### рзз. `req.params` (ржкрзЛрж╕рзНржЯ ржЖржЗржбрж┐)

`const { postId } = req.params;` ржПрж░ ржорж╛ржзрзНржпржорзЗ URL ржерзЗржХрзЗ ржУржЗ ржкрзЛрж╕рзНржЯрзЗрж░ ржЖржЗржбрж┐ ржирзЗржУрзЯрж╛ рж╣ржЪрзНржЫрзЗ ржпрзЗржЯрж┐ржХрзЗ ржЖржкржбрзЗржЯ ржХрж░рждрзЗ рж╣ржмрзЗред ржпрзЗржоржи: `/posts/123` рж╣рж▓рзЗ `postId` рж╣ржмрзЗ `123`ред

### рзи. `req.user` (ржЕржерзЗржиржЯрж┐ржХрзЗрж╢ржи)

ржПржЦрж╛ржирзЗ ржЗржЙржЬрж╛рж░ ржбрж╛ржЯрж╛ рж╕рж░рж╛рж╕рж░рж┐ `req.user` ржерзЗржХрзЗ ржирзЗржУрзЯрж╛ рж╣ржЪрзНржЫрзЗред рж╕рж╛ржзрж╛рж░ржгржд ржХрзЛржирзЛ ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░ (ржпрзЗржоржи: Better Auth) ржЗржЙржЬрж╛рж░ рж▓ржЧржЗржи ржХрж░рж╛ ржерж╛ржХрж▓рзЗ рждрж╛рж░ рждржерзНржп ржПржЦрж╛ржирзЗ рж╕рзЗржЯ ржХрж░рзЗ ржжрзЗрзЯред ржПржЦрж╛ржи ржерзЗржХрзЗ ржЗржЙржЬрж╛рж░рзЗрж░ **ID** ржПржмржВ **Role** (ржпрзЗржоржи: Admin ржмрж╛ User) рж╕ржВржЧрзНрж░рж╣ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред

### рзй. `updatePost` Function (ржмрж┐ржЬржирзЗрж╕ рж▓ржЬрж┐ржХ)

ржПржЯрж┐ ржПржХржЯрж┐ **Service Function** ржпрж╛ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рзЗред ржПржЦрж╛ржирзЗ рзкржЯрж┐ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржкрж╛ржарж╛ржирзЛ рж╣ржЪрзНржЫрзЗ:

- **postId:** ржХрзЛржи ржкрзЛрж╕рзНржЯржЯрж┐ ржЖржкржбрзЗржЯ рж╣ржмрзЗред
- **user.id:** ржХрзЗ ржЖржкржбрзЗржЯ ржХрж░ржЫрзЗ (ржирж┐рж░рж╛ржкрждрзНрждрж╛рж░ ржЬржирзНржп ржЬрж░рзБрж░рж┐)ред
- **user.role:** ржЗржЙржЬрж╛рж░рзЗрж░ ржкрж╛ржУрзЯрж╛рж░ ржХрждржЯрзБржХрзБ (ржпрзЗржоржи: ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ ржирж╛)ред
- **req.body:** ржЗржЙржЬрж╛рж░ ржирждрзБржи ржХрзА рждржерзНржп (Title, Content ржЗрждрзНржпрж╛ржжрж┐) ржкрж╛ржарж┐рзЯрзЗржЫрзЗред

## ЁЯУМ Service ржЙржжрж╛рж╣рж░ржг

```ts
import { Role } from "@prisma/client";

export const updatePost = async (postId, userId, userRole, payload) => {
  // 1я╕ПтГг Post ржЖржЫрзЗ ржХрж┐ржирж╛ ржпрж╛ржЪрж╛ржЗ
  const post = await prisma.post.findUnique({
    where: { id: postId },
  });

  if (!post) {
    throw new NotFoundError("Post not found");
  }

  // 2я╕ПтГг Permission check
  const isAdmin = userRole === Role.ADMIN;
  const isAuthor = post.authorId === userId;

  if (!isAdmin && !isAuthor) {
    throw new ForbiddenError("You are not allowed to update this post");
  }

  // 3я╕ПтГг Field-level security (Admin ржЫрж╛рзЬрж╛ sensitive field ржмрж╛ржж)
  const safePayload = isAdmin
    ? payload
    : {
        title: payload.title,
        content: payload.content,
      };

  // 4я╕ПтГг Update
  return prisma.post.update({
    where: { id: postId },
    data: safePayload,
  });
};
```

ржПржЗ ржХрзЛржбржЯрж┐ ржорзВрж▓ржд ржПржХржЯрж┐ **Service Function** ржпрж╛ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржкрзЛрж╕рзНржЯ ржЖржкржбрзЗржЯ ржХрж░рж╛рж░ ржЖржЧрзЗ **ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржПржмржВ ржЕржирзБржорждрж┐ (Authorization)** ржпрж╛ржЪрж╛ржЗ ржХрж░рзЗред ржирж┐ржЪрзЗ ржПрж░ ржкрзНрж░ржзрж╛ржи ржХрж╛ржЬржЧрзБрж▓рзЛ рж╕рж╣ржЬржнрж╛ржмрзЗ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ:

### рзз. ржкрзЛрж╕рзНржЯ ржпрж╛ржЪрж╛ржЗ (Existence Check)

`prisma.post.findUnique` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржкрзНрж░ржержорзЗ ржжрзЗржЦрж╛ рж╣рзЯ ржпрзЗ ржУржЗ `postId` ржжрж┐рзЯрзЗ ржХрзЛржирзЛ ржкрзЛрж╕рзНржЯ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржЖржЫрзЗ ржХрж┐ ржирж╛ред ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ, рждржмрзЗ ржПржХржЯрж┐ ржПрж░рж░ ржерзНрж░рзЛ ржХрж░рзЗ ржЬрж╛ржирж╛ржирзЛ рж╣рзЯ ржпрзЗ ржкрзЛрж╕рзНржЯржЯрж┐ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред

### рзи. ржЕржирзБржорждрж┐ ржмрж╛ ржкрж╛рж░ржорж┐рж╢ржи ржпрж╛ржЪрж╛ржЗ (Authorization Logic)

```ts
if (!isAdmin && !isAuthor) {
  throw new Error();
}
```

ржПржЗ ржлрж╛ржВрж╢ржиржЯрж┐рж░ рж╕ржмржЪрзЗрзЯрзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржЕржВрж╢ рж╣рж▓рзЛ ржПржЯрж┐ ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рж╛ ржпрзЗтАФ**ржХрзЗ ржкрзЛрж╕рзНржЯржЯрж┐ ржПржбрж┐ржЯ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ?**

- **isAdmin:** ржпржжрж┐ ржЗржЙржЬрж╛рж░рзЗрж░ рж░рзЛрж▓ `ADMIN` рж╣рзЯред
- **isAuthor:** ржпржжрж┐ ржкрзЛрж╕рзНржЯрзЗрж░ ржЖрж╕рж▓ рж▓рзЗржЦржХ (`authorId`) ржПржмржВ ржмрж░рзНрждржорж╛ржи ржЗржЙржЬрж╛рж░ (`userId`) ржПржХржЗ ржмрзНржпржХрзНрждрж┐ рж╣ржиред

### рзй. ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржлрж┐рж▓рзНржЯрж╛рж░ (Security Guard)

`if (!isAdmin && !isAuthor)`тАФржПржЗ рж╢рж░рзНрждржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ, ржЗржЙржЬрж╛рж░ ржпржжрж┐ ржЕрзНржпрж╛ржбржорж┐ржи ржирж╛ рж╣ржи ржПржмржВ ржкрзЛрж╕рзНржЯрзЗрж░ рж▓рзЗржЦржХржУ ржирж╛ рж╣ржи, рждржмрзЗ рждрж┐ржирж┐ ржкрзЛрж╕рзНржЯржЯрж┐ ржЖржкржбрзЗржЯ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржирж╛ред рж╕рзЗржХрзНрж╖рзЗрждрзНрж░рзЗ **"Forbidden"** ржПрж░рж░ ржжрзЗржУрзЯрж╛ рж╣рзЯред ржПржЯрж┐ ржЕржирзНржп ржЗржЙржЬрж╛рж░рзЗрж░ ржбрж╛ржЯрж╛ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛ ржерзЗржХрзЗ рж░ржХрзНрж╖рж╛ ржХрж░рзЗред

### 4. рж╕рзЗржирж╕рж┐ржЯрж┐ржн ржлрж┐рж▓рзНржб ржкрзНрж░ржЯрзЗржХрж╢ржи (Field-Level Security)

```ts
const safePayload = isAdmin
  ? payload
  : {
      title: payload.title,
      content: payload.content,
    };
```

ржПржЯрж┐ ржПржХржЯрж┐ ржЕрждрзНржпржирзНржд ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ рж▓рзЗрзЯрж╛рж░ред ржЕржирзЗржХ рж╕ржорзЯ ржкрзЛрж╕рзНржЯрзЗ ржХрж┐ржЫрзБ рж╕рзНржкрзЗрж╢рж╛рж▓ ржлрж┐ржЪрж╛рж░ ржерж╛ржХрзЗ (ржпрзЗржоржи: `isFeatured` ржмрж╛ `status`), ржпрж╛ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЕрзНржпрж╛ржбржорж┐ржи ржХржирзНржЯрзНрж░рзЛрж▓ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред ржПржХржЬржи рж╕рж╛ржзрж╛рж░ржг рж▓рзЗржЦржХ ржирж┐ржЬрзЗрж░ ржкрзЛрж╕рзНржЯ ржПржбрж┐ржЯ ржХрж░рждрзЗ ржкрж╛рж░рж▓рзЗржУ ржпрж╛рждрзЗ ржнрзБрж▓ ржХрж░рзЗ ржмрж╛ рж╣рзНржпрж╛ржХрж┐ржВрзЯрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржирж┐ржЬрзЗржХрзЗ "Featured" ржХрж░рждрзЗ ржирж╛ ржкрж╛рж░рзЗ, рждрж╛ржЗ ржПржЗ ржХрзЛржбржЯрж┐ рж╕рзЗржЗ ржбрж╛ржЯрж╛ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржерзЗржХрзЗ ржорзБржЫрзЗ ржжрзЗрзЯред

### 5. ржбрж╛ржЯрж╛ ржЖржкржбрзЗржЯ (Database Update)

рж╕ржмржХрж┐ржЫрзБ ржарж┐ржХ ржерж╛ржХрж▓рзЗ рж╕ржмрж╢рзЗрж╖рзЗ `prisma.post.update` ржХржорж╛ржирзНржбржЯрж┐ ржЪрж▓рзЗред ржПржЯрж┐ `payload` (ржпрзЗрж╕ржм ржирждрзБржи рждржерзНржп ржЗржЙржЬрж╛рж░ ржкрж╛ржарж┐рзЯрзЗржЫрзЗ) ржжрж┐рзЯрзЗ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржерж╛ржХрж╛ ржкрзЛрж╕рзНржЯржЯрж┐ ржЖржкржбрзЗржЯ ржХрж░рзЗ ржжрзЗрзЯред

---

### рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк ржлрзНрж▓рзЛ-ржЪрж╛рж░рзНржЯ:

| ржзрж╛ржк           | ржХрж╛ржЬ                 | ржХрзЗржи ржХрж░рж╛ рж╣рзЯ?                               |
| ------------- | ------------------- | ----------------------------------------- |
| **рзз. Find**   | ржкрзЛрж╕рзНржЯ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛ | ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржбрж╛ржЯрж╛ ржЖржЫрзЗ ржХрж┐ ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд рж╣рждрзЗред      |
| **рзи. Verify** | ржЗржЙржЬрж╛рж░ ржЪрзЗржХ ржХрж░рж╛       | ржпрж╛рждрзЗ ржЕржиржзрж┐ржХрж╛рж░ ржХрзЗржЙ ржкрзЛрж╕рзНржЯ ржПржбрж┐ржЯ ржХрж░рждрзЗ ржирж╛ ржкрж╛рж░рзЗред |
| **рзй. Update** | ржбрж╛ржЯрж╛ ржЖржкржбрзЗржЯ ржХрж░рж╛      | ржирждрзБржи рждржерзНржп ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ рж╕рзЗржн ржХрж░рждрзЗред              |
