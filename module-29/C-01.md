# ЁЯЫбя╕П Comment Management System (Default Approved)

ржПржЗ рж╕рж┐рж╕рзНржЯрзЗржорзЗ ржЗржЙржЬрж╛рж░ ржХржорзЗржирзНржЯ ржХрж░рж▓рзЗ рждрж╛ рж╕рж░рж╛рж╕рж░рж┐ рж▓рж╛ржЗржн рж╣ржмрзЗ, ржХрж┐ржирзНрждрзБ ржПржбржорж┐ржи ржЪрж╛ржЗрж▓рзЗ ржпрзЗржХрзЛржирзЛ рж╕ржорзЯ рждрж╛ рж╣рж╛ржЗржб (Reject) ржмрж╛ рж░рж┐ржнрж┐ржЙ (Pending) ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗред

---

## ЁЯзй Step 1: Prisma Schema Design

ржкрзНрж░ржержорзЗ ржбрж╛ржЯрж╛ржмрзЗржЬ ржоржбрзЗрж▓рзЗ `status` ржлрж┐рж▓рзНржбрзЗ ржбрж┐ржлрж▓рзНржЯ ржнрзНржпрж╛рж▓рзБ `APPROVED` рж╕рзЗржЯ ржХрж░рждрзЗ рж╣ржмрзЗред

```prisma
// schema.prisma

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

model Comment {
  id        String        @id @default(uuid())
  content   String
  postId    String
  authorId  String

  // ржбрж┐ржлрж▓рзНржЯржнрж╛ржмрзЗ ржХржорзЗржирзНржЯ APPROVED ржерж╛ржХржмрзЗ
  status    CommentStatus @default(APPROVED)

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  post      Post          @relation(fields: [postId], references: [id])
  author    User          @relation(fields: [authorId], references: [id])
}

```

---

## тЪЩя╕П Step 2: Service Layer (Business Logic)

ржПржбржорж┐ржи ржпржЦржи ржХрзЛржирзЛ ржХржорзЗржирзНржЯрзЗрж░ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржЪрж╛ржЗржмрзЗ, рждржЦржи ржПржЗ рж▓ржЬрж┐ржХржЯрж┐ ржХрж╛ржЬ ржХрж░ржмрзЗред

```ts
// adminComment.service.ts
import { CommentStatus } from "@prisma/client";
import { prisma } from "../../shared/prisma";

// рзз. ржПржбржорж┐ржи ржЪрж╛ржЗрж▓рзЗ рж╕ржм ржХржорзЗржирзНржЯ ржжрзЗржЦрждрзЗ ржкрж╛рж░ржмрзЗ (ржлрж┐рж▓рзНржЯрж╛рж░рж╕рж╣)
export const getAllCommentsFromDB = async (status?: CommentStatus) => {
  return await prisma.comment.findMany({
    where: status ? { status } : {}, // ржпржжрж┐ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржжрзЗржУрзЯрж╛ рж╣рзЯ рждржмрзЗ ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░ржмрзЗ
    include: {
      author: { select: { name: true, email: true } },
      post: { select: { title: true } },
    },
    orderBy: { createdAt: "desc" },
  });
};

// рзи. ржХржорзЗржирзНржЯ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржЖржкржбрзЗржЯ ржХрж░рж╛ (ржПржбржорж┐ржи ржЕрзНржпрж╛ржХрж╢ржи)
export const updateCommentStatusInDB = async (
  commentId: string,
  nextStatus: CommentStatus
) => {
  //1. ржХржорзЗржирзНржЯржЯрж┐ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржЖржЫрзЗ ржХрж┐ ржирж╛ ржпрж╛ржЪрж╛ржЗ
  const isExist = await prisma.comment.findUnique({
    where: { id: commentId },
  });

  if (!isExist) {
    throw new Error("Comment not found!");
  }
  // 2. Same status ржЖржмрж╛рж░ ржкрж╛ржарж╛ржирзЛ рж╣рж▓рзЗ
  if (comment.status === status) {
    throw new AppError(400, `Comment is already ${status.toLowerCase()}`);
  }

  // рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржЖржкржбрзЗржЯ (APPROVED -> REJECTED / PENDING)
  return await prisma.comment.update({
    where: { id: commentId },
    data: { status: nextStatus },
  });
};
```

---

## ЁЯЪА Step 3: Controller Layer

```ts
// adminComment.controller.ts
import { Request, Response } from "express";
import * as AdminCommentService from "./adminComment.service";

export const changeStatus = async (req: Request, res: Response) => {
  try {
    const { commentId } = req.params;
    const { status } = req.body; // ржПржбржорж┐ржи ржкрж╛ржарж╛ржмрзЗ: 'REJECTED' ржЕржержмрж╛ 'PENDING'

    const result = await AdminCommentService.updateCommentStatusInDB(
      commentId,
      status
    );

    res.status(200).json({
      success: true,
      message: `Comment status updated to ${status} successfully`,
      data: result,
    });
  } catch (error: any) {
    res.status(400).json({
      success: false,
      message: error.message || "Internal Server Error",
    });
  }
};
```

---

## ЁЯЫгя╕П Step 4: Routes (Admin Control)

ржПржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓рзЗрж░ ржЬржирзНржп рж░рзБржЯржЧрзБрж▓рзЛ рж╕рзЗржЯржЖржк ржХрж░рж╛ред

```ts
// adminComment.route.ts
import { Router } from "express";
import auth from "../../middlewares/auth";

const router = Router();

// рж╕ржм ржХржорзЗржирзНржЯрзЗрж░ рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрж╛рж░ ржЬржирзНржп
router.get("/", auth("ADMIN"), AdminCommentController.getAllComments);

// рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛рж░ ржЬржирзНржп (ржпрзЗржоржи ржХрзЛржирзЛ рж╕рзНржкрзНржпрж╛ржо ржХржорзЗржирзНржЯ REJECT ржХрж░рждрзЗ)
router.patch(
  "/:commentId/status",
  auth("ADMIN"),
  AdminCommentController.changeStatus
);

export const AdminCommentRoutes = router;
```

---

## ЁЯМН Step 5: Public API (User Side)

ржЗржЙржЬрж╛рж░ ржпржЦржи ржХрзЛржирзЛ ржкрзЛрж╕рзНржЯ ржкрзЬржмрзЗ, рж╕рзЗ рж╢рзБржзрзБ рж╕рзЗржЗ ржХржорзЗржирзНржЯржЧрзБрж▓рзЛржЗ ржжрзЗржЦржмрзЗ ржпрзЗржЧрзБрж▓рзЛрж░ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ `APPROVED` ржЖржЫрзЗред

```ts
// publicPost.service.ts
export const getActiveComments = async (postId: string) => {
  return await prisma.comment.findMany({
    where: {
      postId: postId,
      status: "APPROVED", // рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржкрзНрж░рзБржнржб ржХржорзЗржирзНржЯ ржжрзЗржЦрж╛ржмрзЗ
    },
    include: {
      author: { select: { name: true } },
    },
    orderBy: { createdAt: "asc" },
  });
};
```

---

### ЁЯУЭ ржорзВрж▓ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк (Flow Summary)

1. **User Post:** ржЗржЙржЬрж╛рж░ ржХржорзЗржирзНржЯ ржХрж░рж▓рзЗ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ рж╕рж░рж╛рж╕рж░рж┐ `status: APPROVED` рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржн рж╣ржмрзЗред
2. **Instant Live:** ржХржорзЗржирзНржЯржЯрж┐ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗржЗ ржУрзЯрзЗржмрж╕рж╛ржЗржЯрзЗ рж╕ржмрж╛ржЗ ржжрзЗржЦрждрзЗ ржкрж╛ржмрзЗред
3. **Admin Review:** ржПржбржорж┐ржи рждрж╛рж░ ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржбрзЗ рж╕ржм ржХржорзЗржирзНржЯ ржжрзЗржЦржмрзЗред ржпржжрж┐ ржХрзЛржирзЛ ржХржорзЗржирзНржЯ ржЦрж╛рж░рж╛ржк ржоржирзЗ рж╣рзЯ, рж╕рзЗржЯрж┐рж░ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ `REJECTED` ржХрж░рзЗ ржжрзЗржмрзЗред
4. **Automatic Hidden:** рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ `REJECTED` рж╣ржУрзЯрж╛рж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ рж╕рзЗржЯрж┐ ржкрж╛ржмрж▓рж┐ржХ рж╕рж╛ржЗржЯ ржерзЗржХрзЗ ржЕржжрзГрж╢рзНржп рж╣рзЯрзЗ ржпрж╛ржмрзЗ (ржХрж╛рж░ржг ржкрж╛ржмрж▓рж┐ржХ ржХрзБрзЯрзЗрж░рж┐рждрзЗ рж╢рзБржзрзБ `status: APPROVED` ржлрж┐рж▓рзНржЯрж╛рж░ ржжрзЗржУрзЯрж╛ ржЖржЫрзЗ)ред
