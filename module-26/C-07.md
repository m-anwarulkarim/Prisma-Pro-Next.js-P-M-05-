# Get Post By Id and Increment View Count (Prisma Guide)

### মূল কনসেপ্ট

ডাটাবেসে হাজার হাজার পোস্ট থাকতে পারে। যখন কোনো ইউজার নির্দিষ্ট লিঙ্কে ক্লিক করেন (যেমন: `post/45a4...`), তখন অ্যাপ্লিকেশনের কাজ হলো শুধু ওই ইউনিক আইডিওয়ালা ডাটাটি খুঁজে বের করা। এরপর ওই পোস্টের ভিউ সংখ্যা (View Count) ১ বাড়িয়ে দেওয়া। এর জন্য আমরা Prisma-র **`findUnique`** এবং **`update`** মেথড একটি **Transaction**-এর মাধ্যমে ব্যবহার করি।

```ts
app.get("/post/:id", async (req, res) => {
  // ১. সরাসরি আইডিটি নাও (রূপান্তর করার দরকার নেই)
  const postId = req.params.id;

  try {
    const updatedPost = await prisma.$transaction(async (tx) => {
      // ২. সরাসরি স্ট্রিং আইডি দিয়েই খোঁজো
      const post = await tx.post.findUnique({
        where: { id: postId },
      });

      if (!post) {
        throw new Error("Post not found");
      }

      const postWithNewView = await tx.post.update({
        where: { id: postId },
        data: {
          viewCount: { increment: 1 },
        },
      });

      return postWithNewView;
    });

    res.json(updatedPost);
  } catch (error) {
    res.status(error.message === "Post not found" ? 404 : 500).json({
      error: error.message,
    });
  }
});
```

---

### ১. রাউট এবং প্যারামিটার (`/post/:id`)

প্রথমে আমাদের ইউজার যে আইডিটি পাঠিয়েছে সেটি রিসিভ করতে হবে।

```javascript
app.get("/post/:id", async (req, res) => {
  const postId = req.params.id; // URL থেকে ডাইনামিক আইডিটি নেওয়া হলো

```

- **`:id`**: এটি একটি ডাইনামিক ভেরিয়েবল। ইউজার যখন ব্রাউজারে `post/45a4-uuid-string` লিখবে, তখন ওই আইডিটি `req.params.id`-এ চলে আসবে।
- **সরাসরি আইডি:** যেহেতু তোমার আইডিটি একটি **UUID** (স্ট্রিং), তাই একে `Number()`-এ রূপান্তর করার প্রয়োজন নেই।

---

### ২. ট্রানজ্যাকশনের গুরুত্ব (`prisma.$transaction`)

ডাটা রিড করা এবং আপডেট করা—এই দুটি কাজকে একটি "নিরাপদ প্যাকেজ" বানানোর জন্য ট্রানজ্যাকশন ব্যবহার করা হয়।

```javascript
const updatedPost = await prisma.$transaction(async (tx) => { ... })

```

- **সুবিধা:** একে বলা হয় **Interactive Transaction**। যদি পোস্টটি খুঁজে পাওয়া না যায় অথবা ভিউ আপডেট করার সময় কোনো এরর হয়, তবে ডাটাবেসে কোনো ভুল পরিবর্তন হবে না (সবকিছু **Rollback** হয়ে যাবে)।

---

### ৩. ডাটা খুঁজে বের করা (`findUnique`)

ট্রানজ্যাকশনের ভেতর প্রথম কাজ হলো আইডি দিয়ে পোস্টটি ডাটাবেসে আছে কি না তা নিশ্চিত করা।

```javascript
const post = await tx.post.findUnique({
  where: { id: postId },
});
```

- আমরা ডাটাবেসকে বলছি: "এই `id`-র সাথে মিলে যায় এমন একটি মাত্র পোস্ট আমাকে দাও।"
- পোস্ট না থাকলে `post` ভেরিয়েবলটি **null** রিটার্ন করবে।

---

### ৪. এরর হ্যান্ডলিং (`if (!post)`)

যদি পোস্টটি খুঁজে পাওয়া না যায়, তবে অপারেশনটি ওখানেই বন্ধ করে দিতে হবে।

```javascript
if (!post) {
  throw new Error("Post not found");
}
```

- এটি একটি এরর "থ্রো" করে, যা সরাসরি নিচের `catch` ব্লকে চলে যায়। এর ফলে ভুল আইডি নিয়ে ডাটাবেস আপডেট করার চেষ্টা হয় না।

---

### ৫. ভিউ আপডেট এবং ইনক্রিমেন্ট (`increment: 1`)

পোস্ট পাওয়া গেলে আমরা তার ভিউ সংখ্যা সরাসরি ডাটাবেস লেভেলে বাড়িয়ে দেই।

```javascript
const postWithNewView = await tx.post.update({
  where: { id: postId },
  data: {
    viewCount: { increment: 1 },
  },
});
```

- **Atomic Operation:** এটি ডাটাবেস ইঞ্জিনকে সরাসরি বলে বর্তমান সংখ্যার সাথে ১ যোগ করতে।
- **Race Condition রোধ:** যদি একই সেকেন্ডে ১০০ জন মানুষ পোস্টটি দেখে, ডাটাবেস একে একে (সিরিয়ালি) ১০০ বার ১ যোগ করবে। ফলে ১টি ভিউও মিস হবে না।

---

### ৬. রেসপন্স পাঠানো

সব কাজ সফলভাবে শেষ হলে ইউজারকে রেজাল্ট জানানো হয়।

```javascript
    res.json(updatedPost); // সফল হলে নতুন ভিউসহ ডাটা দেখাবে

  } catch (error) {
    // এরর অনুযায়ী স্ট্যাটাস কোড পাঠানো (404 অথবা 500)
    res.status(error.message === "Post not found" ? 404 : 500).json({
      error: error.message
    });
  }
});

```

- **404 (Not Found):** যদি আইডিটি ভুল হয়।
- **500 (Internal Server Error):** যদি অন্য কোনো টেকনিক্যাল সমস্যা হয়।

---

### সারাংশ: পুরো সার্কেল একনজরে

| ধাপ                 | কাজ                   | কেন প্রয়োজন?                               |
| ------------------- | --------------------- | ------------------------------------------ |
| **১. রিসিভ**        | `req.params.id` নেওয়া | ইউজার কোন পোস্টটি দেখতে চায় তা জানার জন্য। |
| **২. ট্রানজ্যাকশন** | `prisma.$transaction` | রিড ও আপডেট অপারেশন নিরাপদ রাখতে।          |
| **৩. সার্চ**        | `findUnique`          | ডাটাবেসে পোস্টের অস্তিত্ব যাচাই করতে।      |
| **৪. আপডেট**        | `{ increment: 1 }`    | নিখুঁতভাবে ভিউ সংখ্যা বাড়ানোর জন্য।        |
| **৫. রেসপন্স**      | `res.json()`          | ইউজারকে চূড়ান্ত রেজাল্ট দেখানোর জন্য।      |
