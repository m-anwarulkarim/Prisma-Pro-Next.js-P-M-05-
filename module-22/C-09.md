## ЁЯФД Prisma: Upsert & Nested Operations (The Full Guide)

Prisma-рждрзЗ **Upsert** рж╣рж▓рзЛ ржПржоржи ржПржХржЯрж┐ ржЕржкрж╛рж░рзЗрж╢ржи ржпрж╛ ржПржХржЗ рж╕рж╛ржерзЗ **Update** ржПржмржВ **InSert** ржПрж░ ржХрж╛ржЬ ржХрж░рзЗред ржПржЯрж┐ ржЪрзЗржХ ржХрж░рзЗ ржжрзЗржЦрзЗ ржпрзЗ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржбрж╛ржЯрж╛ржЯрж┐ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржЖржЫрзЗ ржХрж┐ ржирж╛; ржерж╛ржХрж▓рзЗ ржЖржкржбрзЗржЯ ржХрж░рзЗ, ржирж╛ ржерж╛ржХрж▓рзЗ ржирждрзБржи рждрзИрж░рж┐ ржХрж░рзЗред

### ЁЯЫая╕П ржХрзЛржб ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯрзЗрж╢ржи

```typescript
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

async function main() {
  /**
   * ----------------------------------------------------------------
   * 1) UPSERT: Update if exists, else Create
   * ----------------------------------------------------------------
   * рж▓ржЬрж┐ржХ:
   * - where: ржЗржЙржирж┐ржХ ржлрж┐рж▓рзНржб ржжрж┐рзЯрзЗ ржЪрзЗржХ ржХрж░ржмрзЗред
   * - update: ржпржжрж┐ рж░рзЗржХрж░рзНржб ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ, рждржмрзЗ ржПржЗ ржбрж╛ржЯрж╛ ржжрж┐рзЯрзЗ ржЖржкржбрзЗржЯ рж╣ржмрзЗред
   * - create: ржпржжрж┐ рж░рзЗржХрж░рзНржб ржирж╛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ, рждржмрзЗ ржПржЗ ржбрж╛ржЯрж╛ ржжрж┐рзЯрзЗ ржирждрзБржи рждрзИрж░рж┐ рж╣ржмрзЗред
   */
  const upsertUser = await prisma.user.upsert({
    where: { email: "karim@example.com" }, // ржЗржЙржирж┐ржХ ржлрж┐рж▓рзНржб ржЪрзЗржХ
    update: {
      name: "Karim Updated",
    },
    create: {
      email: "karim@example.com",
      name: "Karim New",
    },
  });

  console.log("тЬЕ Upserted User:", upsertUser);

  /**
   * ----------------------------------------------------------------
   * 2) Nested UPSERT with Relations
   * ----------------------------------------------------------------
   * ржЖржкржирж┐ ржпржЦржи ржкрзНржпрж╛рж░рзЗржирзНржЯ (User) ржПрж░ рж╕рж╛ржерзЗ ржЪрж╛ржЗрж▓рзНржб (Post) ржбрж╛ржЯрж╛
   * ржПржХрж╕рж╛ржерзЗ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ ржЪрж╛ржи рждржЦржи ржПржЯрж┐ ржмрзНржпржмрж╣рзГржд рж╣рзЯред
   */
  const nestedUpsert = await prisma.user.upsert({
    where: { email: "karim@example.com" },
    update: {
      name: "Karim Updated Again",
      posts: {
        create: {
          title: "New Post Added via Upsert",
          content: "Content description here",
        },
      },
    },
    create: {
      email: "karim@example.com",
      name: "Karim New User",
      posts: {
        create: {
          title: "First Post",
          content: "Welcome to our platform!",
        },
      },
    },
    // ржЖржЙржЯржкрзБржЯрзЗ ржкрзЛрж╕рзНржЯрзЗрж░ рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрж╛рж░ ржЬржирзНржп include ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ
    include: { posts: true },
  });

  console.log("ЁЯЪА Nested Upsert Result:", nestedUpsert);
}

/**
 * ржПржХрзНрж╕рж┐ржХрж┐ржЙрж╢ржи ржПржмржВ ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВ
 */
main()
  .catch((e) => {
    console.error("тЭМ Error:", e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
    console.log("ЁЯФМ Prisma Disconnected.");
  });
```

---

### ЁЯза ржорзВрж▓ ржХржирж╕рзЗржкрзНржЯрж╕ржорзВрж╣рзЗрж░ ржмрзНржпрж╛ржЦрзНржпрж╛ (Core Concepts)

#### рзз. ржХрзЗржи Upsert ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗржи?

ржмрж╛рж╕рзНрждржм ржЬрзАржмржирзЗ ржпржЦржи ржЖржорж░рж╛ 'Profile Update' ржХрж░рж┐, рждржЦржи ржЕржирзЗржХ рж╕ржорзЯ ржжрзЗржЦрж╛ ржпрж╛рзЯ ржЗржЙржЬрж╛рж░ ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржЖржЫрзЗ (Update), ржЖржмрж╛рж░ ржЕржирзЗржХ рж╕ржорзЯ ржерж╛рж░рзНржб-ржкрж╛рж░рзНржЯрж┐ рж▓ржЧржЗржи (ржпрзЗржоржи Google Login) ржПрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржЗржЙржЬрж╛рж░ ржирж╛ржУ ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗ (Create)ред ржПржЗ ржЬржЯрж┐рж▓ рж▓ржЬрж┐ржХржЯрж┐ `upsert` ржПржХрж╛ржЗ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рзЗред

#### рзи. ржЗржЙржирж┐ржХ ржХржирж╕рзНржЯрзНрж░рзЗржЗржирзНржЯ (Unique Constraint)

`upsert` ржПрж░ `where` ржмрзНрж▓ржХрзЗ ржЖржкржирж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ рж╕рзЗржЗ ржлрж┐рж▓рзНржбржЧрзБрж▓рзЛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржпрзЗржЧрзБрж▓рзЛ ржЖржкржирж╛рж░ Prisma Schema-рждрзЗ `@unique` ржмрж╛ `@id` рж╣рж┐рж╕рзЗржмрзЗ ржбрж┐ржлрж╛ржЗржи ржХрж░рж╛ ржЖржЫрзЗред

#### рзй. Nested Upsert ржПрж░ рж╕рзБржмрж┐ржзрж╛

ржкрзНржпрж╛рж░рзЗржирзНржЯ ржЗржЙржЬрж╛рж░ ржЖржкржбрзЗржЯ ржХрж░рж╛рж░ рж╕ржорзЯ ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ рждрж╛рж░ ржЬржирзНржп ржирждрзБржи ржбрж╛ржЯрж╛ ржЪрж╛ржЗрж▓рзНржб ржЯрзЗржмрж┐рж▓рзЗ (ржпрзЗржоржи Post ржмрж╛ Profile) ржЗржирж╕рж╛рж░рзНржЯ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред ржПрждрзЗ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржорж╛рж▓рзНржЯрж┐ржкрж▓ ржХрзБрзЯрзЗрж░рж┐ ржкрж╛ржарж╛ржирзЛрж░ ржкрзНрж░рзЯрзЛржЬржи рж╣рзЯ ржирж╛, ржпрж╛ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржЙржирзНржиржд ржХрж░рзЗред

---

### ЁЯУК ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж╕рж╛рж░рж╛ржВрж╢ (Quick Summary)

| ржЕржкрж╛рж░рзЗрж╢ржи          | ржХрж╛ржЬ                                         | рж░рж┐ржЯрж╛рж░рзНржи ржЯрж╛ржЗржк        |
| ---------------- | ------------------------------------------- | ------------------- |
| **`upsert`**     | ржЪрзЗржХ ржХрж░рзЗ Update ржЕржержмрж╛ Create ржХрж░рзЗ              | Single Object       |
| **`update`**     | рж╢рзБржзрзБржорж╛рждрзНрж░ ржмрж┐ржжрзНржпржорж╛ржи рж╕рж┐ржЩрзНржЧрзЗрж▓ рж░рзЗржХрж░рзНржб ржЖржкржбрзЗржЯ ржХрж░рзЗ | Single Object       |
| **`updateMany`** | рж╢рж░рзНржд ржЕржирзБржпрж╛рзЯрзА ржЕржирзЗржХржЧрзБрж▓рзЛ рж░рзЗржХрж░рзНржб ржЖржкржбрзЗржЯ ржХрж░рзЗ      | `{ count: number }` |
| **`deleteMany`** | рж╢рж░рзНржд ржЕржирзБржпрж╛рзЯрзА ржЕржирзЗржХржЧрзБрж▓рзЛ рж░рзЗржХрж░рзНржб ржорзБржЫрзЗ ржлрзЗрж▓рзЗ      | `{ count: number }` |

---

### тЬЕ ржЯрж┐ржкрж╕ ( Standard)

- **Atomic Transactions:** `upsert` ржирж┐ржЬрзЗржЗ ржПржХржЯрж┐ ржЯрзНрж░рж╛ржиржЬрзНржпрж╛ржХрж╢ржи рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░рзЗред ржЕрж░рзНржерж╛рзО, ржпржжрж┐ ржХрзЛржирзЛ ржХрж╛рж░ржгрзЗ `update` ржмрж╛ `create` ржПрж░ ржХрзЛржирзЛ ржПржХржЯрж┐ ржЕржВрж╢ ржлрзЗржЗрж▓ ржХрж░рзЗ, рждржмрзЗ ржкрзБрж░рзЛ ржЕржкрж╛рж░рзЗрж╢ржиржЯрж┐ ржмрж╛рждрж┐рж▓ рж╣рзЯрзЗ ржпрж╛ржмрзЗред ржПржЯрж┐ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗрж░ ржЕржЦржгрзНржбрждрж╛ (Integrity) рж░ржХрзНрж╖рж╛ ржХрж░рзЗред
- **Validation:** ржЗржЙржЬрж╛рж░ ржЗржиржкрзБржЯ (ржпрзЗржоржи ржЗржорзЗржЗрж▓) ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржкрж╛ржарж╛ржирзЛрж░ ржЖржЧрзЗ рж╕ржмрж╕ржорзЯ ржнрзНржпрж╛рж▓рж┐ржбрзЗржЯ ржХрж░рзЗ ржирж┐ржи ржпрж╛рждрзЗ `where` ржХрзНрж▓ржЬржЯрж┐ рж╕ржарж┐ржХ ржерж╛ржХрзЗред
